<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Through an Equality Query on a Record What Locks Will Be Added</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	===============<br>
	== <a href="https://nico.moe/">CyberJunk</a> ==<br>
	===============
	<div style="float: right;">Made with ðŸ˜­</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="https://github.com/slk000"><b>Github</b></a>.
			
			<a href="https://lo-li.net"><b>Chinese</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Through an Equality Query on a Record What Locks Will Be Added</h1>
			<b><time>2023.06.18 18:39</time></b>
		       
		           <a href="/tags/database">Database</a>
        	       

			<div>
				<p>In the example table, <code>id</code> is the primary key, create a normal index on field <code>age</code>, and a unique index on <code>name</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">show</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> test<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Create</span> <span style="color:#66d9ef">Table</span>: <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>age<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>msg<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> char(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>name<span style="color:#f92672">`</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>idx_age<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>age<span style="color:#f92672">`</span>)
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COLLATE</span><span style="color:#f92672">=</span>utf8mb4_0900_ai_ci
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> age Â <span style="color:#f92672">|</span> msg Â <span style="color:#f92672">|</span> name <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> a    <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">20</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">4</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">21</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+------+------+------+
</span></span></span></code></pre></div><p>Observe the locking situation under the <strong>RR</strong> level.</p>
<h1 id="1-updating-records-through-the-primary-key-unique-index">1. Updating records through the primary key unique index</h1>
<p>Check the execution plan; it uses the primary index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> Â <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span> Â Â Â Â <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span> Â Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span> <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra Â Â Â Â Â Â <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">UPDATE</span> Â Â Â Â Â <span style="color:#f92672">|</span> test Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> range <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> <span style="color:#f92672">**</span><span style="color:#66d9ef">PRIMARY</span><span style="color:#f92672">**</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> const <span style="color:#f92672">|</span> Â Â Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span> <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+-------+------+----------+-------------+
</span></span></span></code></pre></div><h2 id="11-if-the-record-exists">1.1 If the record exists</h2>
<p>Check the lock information; there is an intention lock and a record lock on the primary key (the unique index degrades the next-key lock to a record lock):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span> Â Changed: <span style="color:#ae81ff">1</span> Â Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1115</span>:<span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">28995</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">48</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: IX  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">49</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">7</span>:<span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">28995</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">48</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,REC_NOT_GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h2 id="12-if-the-record-does-not-exist">1.2 if the record does not exist</h2>
<p>The unique index degrades the next-key lock to a gap lock.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;  
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">0</span> Â Changed: <span style="color:#ae81ff">0</span> Â Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1115</span>:<span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">28997</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">52</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: IX  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">49</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">28997</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">52</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">3</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</span></span></code></pre></div><p>There is a detail to note: if a query like <code>where id=5</code> makes <code>LOCK_DATA</code> as +âˆž, <code>LOCK_MODE</code> will only show <code>X</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: supremum pseudo<span style="color:#f92672">-</span>record
</span></span></code></pre></div><p>Reference: <a href="https://www.aneasystone.com/archives/2018/04/solving-dead-locks-four.html#:~:text=%E5%B9%B6%E4%B8%8D%E6%98%AF%E5%9C%A8%E6%97%A5%E5%BF%97%E9%87%8C%E7%9C%8B%E5%88%B0%20lock_mode%20X%20%E5%B0%B1%E8%AE%A4%E4%B8%BA%E8%BF%99%E6%98%AF%20Next%2Dkey%20%E9%94%81">One thing to note here is that seeing lock_mode X in the log does not necessarily mean this is a Next-key lock, because there is one exception</a>.</p>
<h2 id="13-updating-the-primary-key-itself">1.3 Updating the primary key itself</h2>
<p>Unlike in 1.1, where other fields are updated, when updating the primary key itself, all indexes need to be updated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">where</span> id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span>  Changed: <span style="color:#ae81ff">1</span>  Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">1117</span>:<span style="color:#ae81ff">135950411813584</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411813584</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>
</span></span><span style="display:flex;"><span>            LOCK_MODE: IX
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">7</span>:<span style="color:#ae81ff">135950411810592</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411810592</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X,REC_NOT_GAP
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">135950411810936</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: name
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411810936</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X,REC_NOT_GAP
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#e6db74">&#39;a         &#39;</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">4</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">135950411811280</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: name
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411811280</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: S,GAP
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#e6db74">&#39;a         &#39;</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">5</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">135950411811280</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: name
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411811280</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: S,GAP
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#e6db74">&#39;a         &#39;</span>, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">6</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">135950501940440</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">135950411811624</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">1396778</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: name
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">135950411811624</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: S
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: supremum pseudo<span style="color:#f92672">-</span>record
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</span></span></code></pre></div><p>MySQL updates by <strong>deleting first and then inserting</strong>, so it is also necessary to be aware of the potential deadlocks that may occur during these two stages.
<a href="https://mp.weixin.qq.com/s?__biz=MzUxODAzNDg4NQ==&amp;mid=2247524580&amp;idx=1&amp;sn=8032d1de9a45304f91dbb2e6f5a12e0e&amp;chksm=f98d244ecefaad58a21f730cd9f0646b41e20cd16d20e76c97b6de3b081d3554637366746fd3">ref</a></p>
<h1 id="2-updating-records-through-a-unique-non-primary-key-index">2. Updating records through a unique non-primary key index</h1>
<p>Check the execution plan; it uses the <code>name</code> index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;a&#39;</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+------+---------+-------+------+----------+-------------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> Â <span style="color:#f92672">|</span> possible_key  
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span> Â <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span> Â Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span> <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra Â Â Â Â Â Â <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+------+---------+-------+------+----------+-------------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">UPDATE</span> Â Â Â Â Â <span style="color:#f92672">|</span> test Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> range <span style="color:#f92672">|</span> name Â Â Â Â Â Â Â   
</span></span><span style="display:flex;"><span>Â <span style="color:#f92672">|</span> name <span style="color:#f92672">|</span> <span style="color:#ae81ff">41</span> Â Â Â Â Â <span style="color:#f92672">|</span> const <span style="color:#f92672">|</span> Â Â Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span> <span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+------+---------+-------+------+----------+-------------+  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h2 id="21-record-exists">2.1 Record exists</h2>
<p>Compared to situation 1.1, there is one more lock: a record lock on the <code>name</code> index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;a&#39;</span>; Â Â   
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span> Â Changed: <span style="color:#ae81ff">1</span> Â Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1116</span>:<span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29064</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">153</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: IX  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">50</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29064</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">153</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: name  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,REC_NOT_GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#e6db74">&#39;a Â Â Â Â Â Â Â Â &#39;</span>, <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">50</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">7</span>:<span style="color:#ae81ff">128238328281080</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29064</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">153</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328281080</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,REC_NOT_GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)
</span></span></code></pre></div><h2 id="22-record-does-not-exist">2.2 Record does not exist</h2>
<p>Trying to find a record with <code>name=0</code>. A gap lock is added on the unique <code>name</code> index. This situation is the same as in 1.2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#66d9ef">where</span> name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span>;  
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">0</span> Â Changed: <span style="color:#ae81ff">0</span> Â Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1116</span>:<span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29061</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">140</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: IX  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">50</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29061</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">140</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: name  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#e6db74">&#39;a Â Â Â Â Â Â Â Â &#39;</span>, <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h1 id="3-updating-records-through-a-non-unique-index">3. Updating records through a non-unique index</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#66d9ef">where</span> age<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+---------+---------+-------+------+----------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span> Â <span style="color:#f92672">|</span> possible_key  
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span> Â Â Â Â <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span> Â Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span> <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra Â Â Â Â Â Â   
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+---------+---------+-------+------+----------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">UPDATE</span> Â Â Â Â Â <span style="color:#f92672">|</span> test Â <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> range <span style="color:#f92672">|</span> idx_age Â Â Â Â   
</span></span><span style="display:flex;"><span>Â <span style="color:#f92672">|</span> idx_age <span style="color:#f92672">|</span> <span style="color:#ae81ff">5</span> Â Â Â Â Â Â <span style="color:#f92672">|</span> const <span style="color:#f92672">|</span> Â Â Â <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> Â Â <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--+---------+---------+-------+------+----------+-------------  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">+</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h2 id="31-record-exists">3.1 Record exists</h2>
<p>There are a total of four locks: the intention lock and the record lock on the primary key (row 1,3), row 2 is the next-key lock on the found record, and row 4 is the gap lock before the first mismatched record.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#66d9ef">where</span> age<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;  
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">01</span> sec)  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">1</span> Â Changed: <span style="color:#ae81ff">0</span> Â Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1117</span>:<span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29089</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">168</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: IX  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29089</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">168</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: idx_age  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">128238328281080</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29089</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">168</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328281080</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,REC_NOT_GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">4</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â ENGINE: INNODB  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">128238328281424</span>  
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29089</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â THREAD_ID: <span style="color:#ae81ff">53</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â Â EVENT_ID: <span style="color:#ae81ff">168</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â OBJECT_SCHEMA: t  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â OBJECT_NAME: test  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â PARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â INDEX_NAME: idx_age  
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328281424</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_TYPE: RECORD  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_MODE: X,GAP  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>  
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â Â Â Â LOCK_DATA: <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">3</span>  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h2 id="32-record-does-not-exist">3.2 Record does not exist</h2>
<p>Only the gap lock on that index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#66d9ef">where</span> age<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>;
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Rows</span> matched: <span style="color:#ae81ff">0</span>  Changed: <span style="color:#ae81ff">0</span>  Warnings: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1117</span>:<span style="color:#ae81ff">128238328283648</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29090</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">172</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>
</span></span><span style="display:flex;"><span>            LOCK_MODE: IX
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29090</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">172</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: idx_age
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X,GAP
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><h1 id="4-updating-records-without-using-an-index">4. Updating records without using an index</h1>
<p>The whole table is scanned.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">explain</span> <span style="color:#66d9ef">update</span> test <span style="color:#66d9ef">set</span> age<span style="color:#f92672">=</span>age<span style="color:#f92672">+</span><span style="color:#ae81ff">100</span> <span style="color:#66d9ef">where</span> msg <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> id <span style="color:#f92672">|</span> select_type <span style="color:#f92672">|</span> <span style="color:#66d9ef">table</span> <span style="color:#f92672">|</span> partitions <span style="color:#f92672">|</span> <span style="color:#66d9ef">type</span>  <span style="color:#f92672">|</span> possible_keys <span style="color:#f92672">|</span> <span style="color:#66d9ef">key</span>     <span style="color:#f92672">|</span> key_len <span style="color:#f92672">|</span> <span style="color:#66d9ef">ref</span>  <span style="color:#f92672">|</span> <span style="color:#66d9ef">rows</span> <span style="color:#f92672">|</span> filtered <span style="color:#f92672">|</span> Extra       <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span>  <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">UPDATE</span>      <span style="color:#f92672">|</span> test  <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">index</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span>          <span style="color:#f92672">|</span> <span style="color:#66d9ef">PRIMARY</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">4</span>       <span style="color:#f92672">|</span> <span style="color:#66d9ef">NULL</span> <span style="color:#f92672">|</span>    <span style="color:#ae81ff">3</span> <span style="color:#f92672">|</span>   <span style="color:#ae81ff">100</span>.<span style="color:#ae81ff">00</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">Using</span> <span style="color:#66d9ef">where</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">row</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span>, <span style="color:#ae81ff">1</span> warning (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div><p>Locks all rows in the table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> performance_schema.data_locks<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">1117</span>:<span style="color:#ae81ff">128238328283648</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">186</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328283648</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: <span style="color:#66d9ef">TABLE</span>
</span></span><span style="display:flex;"><span>            LOCK_MODE: IX
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">2</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">186</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: supremum pseudo<span style="color:#f92672">-</span>record
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">3</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">186</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">4</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">186</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">5</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
</span></span><span style="display:flex;"><span>               ENGINE: INNODB
</span></span><span style="display:flex;"><span>       ENGINE_LOCK_ID: <span style="color:#ae81ff">128238397428520</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>ENGINE_TRANSACTION_ID: <span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>            THREAD_ID: <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span>             EVENT_ID: <span style="color:#ae81ff">186</span>
</span></span><span style="display:flex;"><span>        OBJECT_SCHEMA: t
</span></span><span style="display:flex;"><span>          OBJECT_NAME: test
</span></span><span style="display:flex;"><span>       PARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>    SUBPARTITION_NAME: <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>           INDEX_NAME: <span style="color:#66d9ef">PRIMARY</span>
</span></span><span style="display:flex;"><span>OBJECT_INSTANCE_BEGIN: <span style="color:#ae81ff">128238328280736</span>
</span></span><span style="display:flex;"><span>            LOCK_TYPE: RECORD
</span></span><span style="display:flex;"><span>            LOCK_MODE: X
</span></span><span style="display:flex;"><span>          LOCK_STATUS: <span style="color:#66d9ef">GRANTED</span>
</span></span><span style="display:flex;"><span>            LOCK_DATA: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</span></span></code></pre></div>
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/some-notes-on-receivers/">Some notes on Receivers</a></li>
				
				<li><a href="/posts/lock_based_concurrency_control_protocol/">Lock Based Concurrency Control Protocol</a></li>
				
				<li><a href="/posts/through-an-equality-query-on-a-record-what-locks-will-be-added/">Through an Equality Query on a Record What Locks Will Be Added</a></li>
				
				<li><a href="/posts/auto-generated-primary-key-in-mysql/">Auto Generated Primary Key in MySQL</a></li>
				
				<li><a href="/posts/network-programming-model/">Network Programming Model</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2024 <a href="https://nico.moe/"><b>CyberJunk</b></a>.
	<a href="#"><b>#</b></a>.
	</p>
</footer>

</body>
</html>
